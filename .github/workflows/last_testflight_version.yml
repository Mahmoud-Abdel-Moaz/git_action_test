name: Get latest TestFlight build number
on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: macOS-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 2.7.0


    - name: Install Fastlane
      run: gem install fastlane


    - name: Create App store json
      run:  echo  "${{ secrets.APPLE_STORE_API_KEY_JSON }}" > api_key.json

      # Collect the file and upload as artifact
    - name: collect ipa artifacts
      uses: actions/upload-artifact@v2
      with:
        name: api_key
        path: api_key.json

#    - name: Get latest TestFlight build number
#      run: |
#        fastlane run latest_testflight_build_number \
#        app_identifier:"com.nxt.ci" \
#        api_key_path:"api_key.json"


    - name: Get latest TestFlight build number
      id: testflight   # Add an ID for this step
      run: |
        version=$(fastlane run latest_testflight_build_number \
        app_identifier:"com.nxt.ci" \
        api_key_path:"api_key.json" \
        | awk '/[RESULT]/ {print $2}') # parse the output to get the build number
        echo "::set-output name=buildnumber::$version"   # set the output
        echo "The latest TestFlight build number is ${{ steps.testflight.outputs.buildnumber }}"
        version = "55"
        echo "The latest TestFlight build number is ${{ steps.testflight.outputs.buildnumber }}"



#        echo "${{ secrets.APP_STORE_CONNECT_API_PRIVATE_KEY }}" | tr '\n' '\\n'  >>  $env.API_PRIVATE_KEY
